{% extends "base.html" %}

{% block title %}Edit Task - Task Schedule{% endblock %}

{% block content %}
<div class="container">
    <h2>Edit Task</h2>

    <form method="POST" class="task-form">
        <div class="form-group">
            <label for="title">Task Title:</label>
            <input type="text" id="title" name="title" value="{{ task.title }}" required>
        </div>

        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="3">{{ task.description or '' }}</textarea>
        </div>

        <div class="form-group">
            <label>Assign To:</label>
            <div>
                <input type="radio" id="for_everyone" name="for_everyone" value="1"
                       {% if task.for_everyone %}checked{% endif %} onchange="toggleUserSelection()">
                <label for="for_everyone">Everyone</label>
            </div>
            <div>
                <input type="radio" id="for_specific" name="for_everyone" value="0"
                       {% if not task.for_everyone %}checked{% endif %} onchange="toggleUserSelection()">
                <label for="for_specific">Specific Users</label>
            </div>
        </div>

        <div class="form-group" id="user_selection" style="display: {% if task.for_everyone %}none{% else %}block{% endif %};">
            <label onclick="toggleUserGrid()" style="cursor: pointer;">
                Select Users: <span id="user_grid_toggle">▼</span>
            </label>
            <div class="user-grid" id="user_grid">
            {% for user in users %}
                {% if user.first_name.lower() != 'admin' %}
                <div class="user-checkbox">
                    <input type="checkbox" id="user_{{ user.id }}" name="user_ids" value="{{ user.id }}"
                           {% if user.id in assigned_users %}checked{% endif %}>
                    <label for="user_{{ user.id }}">{{ user.first_name }}</label>
                </div>
                {% endif %}
            {% endfor %}
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Update Task</button>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
        <button type="submit" name="delete_task" value="1" class="btn btn-danger"
                onclick="return confirm('Are you sure you want to delete this task?')">Delete Task</button>
    </form>

    <hr>

    <h3>Schedules</h3>
    {% if schedules %}
    <ul class="schedule-list">
        {% for schedule in schedules %}
        <li>
            {{ schedule.description }}
            <form method="POST" style="display: inline;">
                <button type="submit" name="delete_schedule" value="{{ schedule.id }}" class="btn-small btn-danger">Remove</button>
            </form>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No schedules defined yet.</p>
    {% endif %}

    <hr>

    <h3>Add Schedule</h3>
    <form method="POST" class="schedule-form">
        <input type="hidden" name="add_schedule" value="1">

        <div class="form-group">
            <label for="schedule_type">Schedule Type:</label>
            <select id="schedule_type" name="schedule_type" onchange="updateScheduleForm()" required>
                <option value="">Select a schedule type...</option>
                <option value="interval_days">Every X days</option>
                <option value="interval_weeks">Every X weeks</option>
                <option value="interval_months">Every X months</option>
                <option value="weekly">Weekly on specific day</option>
                <option value="ordinal_monthly">Ordinal day of month (e.g., first Saturday)</option>
                <option value="ordinal_bimonthly">Ordinal day of even/odd months</option>
                <option value="monthly_date">Monthly on specific date (e.g., 15th)</option>
                <option value="first_of_month">First day of each month</option>
                <option value="last_of_month">Last day of each month</option>
                <option value="first_last_interval_months">First/Last day every X months</option>
                <option value="times_per_month">X times per month</option>
                <option value="yearly_week">Yearly in specific week</option>
                <option value="yearly_date">Yearly on specific date</option>
                <option value="seasonal">Seasonal</option>
                <option value="one_time">One time</option>
            </select>
        </div>

        <div id="schedule_fields"></div>

        <button type="submit" class="btn btn-primary">Add Schedule</button>
    </form>

    {% if task.created_by %}
    <div class="task-creator">
        <p>Created by: {{ task.created_by.capitalize() }}</p>
    </div>
    {% endif %}
</div>

<script>
function toggleUserSelection() {
    const forEveryone = document.getElementById('for_everyone').checked;
    const userSelection = document.getElementById('user_selection');
    userSelection.style.display = forEveryone ? 'none' : 'block';
}

function toggleUserGrid() {
    const userGrid = document.getElementById('user_grid');
    const toggleIcon = document.getElementById('user_grid_toggle');
    if (userGrid.style.display === 'none') {
        userGrid.style.display = 'grid';
        toggleIcon.textContent = '▼';
    } else {
        userGrid.style.display = 'none';
        toggleIcon.textContent = '►';
    }
}

function updateScheduleForm() {
    const scheduleType = document.getElementById('schedule_type').value;
    const fieldsDiv = document.getElementById('schedule_fields');
    fieldsDiv.innerHTML = '';

    if (!scheduleType) return;

    if (scheduleType === 'interval_days' || scheduleType === 'interval_weeks' || scheduleType === 'interval_months') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="interval">Interval:</label>
                <input type="number" id="interval" name="interval" min="1" required>
            </div>
            <div class="form-group">
                <label for="start_date">Start Date (YYYY-MM-DD):</label>
                <input type="date" id="start_date" name="start_date" required>
            </div>
            <div class="form-group">
                <label for="end_date">End Date (optional, YYYY-MM-DD):</label>
                <input type="date" id="end_date" name="end_date">
            </div>
        `;
    } else if (scheduleType === 'weekly') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="day_of_week">Day of Week:</label>
                <select id="day_of_week" name="day_of_week" required>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
        `;
    } else if (scheduleType === 'ordinal_monthly') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="ordinal">Ordinal:</label>
                <select id="ordinal" name="ordinal" required>
                    <option value="first">First</option>
                    <option value="second">Second</option>
                    <option value="third">Third</option>
                    <option value="fourth">Fourth</option>
                    <option value="last">Last</option>
                </select>
            </div>
            <div class="form-group">
                <label for="day_of_week">Day of Week:</label>
                <select id="day_of_week" name="day_of_week" required>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
        `;
    } else if (scheduleType === 'ordinal_bimonthly') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="ordinal">Ordinal:</label>
                <select id="ordinal" name="ordinal" required>
                    <option value="first">First</option>
                    <option value="second">Second</option>
                    <option value="third">Third</option>
                    <option value="fourth">Fourth</option>
                    <option value="last">Last</option>
                </select>
            </div>
            <div class="form-group">
                <label for="day_of_week">Day of Week:</label>
                <select id="day_of_week" name="day_of_week" required>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
            <div class="form-group">
                <label for="even_odd_months">Months:</label>
                <select id="even_odd_months" name="even_odd_months" required>
                    <option value="even">Even</option>
                    <option value="odd">Odd</option>
                </select>
            </div>
        `;
    } else if (scheduleType === 'monthly_date') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="day_of_month">Day of Month (1-31):</label>
                <input type="number" id="day_of_month" name="day_of_month" min="1" max="31" required>
            </div>
        `;
    } else if (scheduleType === 'first_last_interval_months') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="first_or_last">First or Last:</label>
                <select id="first_or_last" name="first_or_last" required>
                    <option value="first">First</option>
                    <option value="last">Last</option>
                </select>
            </div>
            <div class="form-group">
                <label for="interval">Interval (months):</label>
                <input type="number" id="interval" name="interval" min="1" required>
            </div>
            <div class="form-group">
                <label for="start_date">Start Date (YYYY-MM-DD):</label>
                <input type="date" id="start_date" name="start_date" required>
            </div>
            <div class="form-group">
                <label for="end_date">End Date (optional, YYYY-MM-DD):</label>
                <input type="date" id="end_date" name="end_date">
            </div>
        `;
    } else if (scheduleType === 'times_per_month') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="times_count">Times per Month:</label>
                <input type="number" id="times_count" name="times_count" min="1" required>
            </div>
        `;
    } else if (scheduleType === 'yearly_week') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="week_of_year">Week of Year (1-52):</label>
                <input type="number" id="week_of_year" name="week_of_year" min="1" max="52" required>
            </div>
            <div class="form-group">
                <label for="month">Month:</label>
                <select id="month" name="month" required>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
        `;
    } else if (scheduleType === 'yearly_date') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="month">Month:</label>
                <select id="month" name="month" required>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="form-group">
                <label for="day_of_month">Day of Month:</label>
                <input type="number" id="day_of_month" name="day_of_month" min="1" max="31" required>
            </div>
        `;
    } else if (scheduleType === 'seasonal') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="season">Season:</label>
                <select id="season" name="season" required>
                    <option value="Spring">Spring</option>
                    <option value="Summer">Summer</option>
                    <option value="Fall">Fall</option>
                    <option value="Winter">Winter</option>
                </select>
            </div>
        `;
    } else if (scheduleType === 'one_time') {
        fieldsDiv.innerHTML = `
            <div class="form-group">
                <label for="specific_date">Date (YYYY-MM-DD):</label>
                <input type="date" id="specific_date" name="specific_date" required>
            </div>
        `;
    }
}
</script>
{% endblock %}
